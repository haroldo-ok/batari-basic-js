<!doctype html>
<html lang="en-us">
  <head>
	<title>A quick and dirty experiment on compiling Batari Basic programs on the Browser.</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">  
  </head>
  <body>
	<h1 class="title">A quick and dirty experiment on compiling Batari Basic programs on the Browser.</h1>
  
	<style>
		textarea {
			white-space: pre;
		}
		
		.fill-vertically {
			height: 60vh;
			overflow-y: auto;
		}
		
		.full-height {
			height: 100%;
		}
		
		.full-height-without-heading.textarea[rows] {
			height: calc(100% - 3em);
		}
		
		.footer {
			padding: 0;
		}
		
		.float-right {
			float: right;
		}
	</style>

	<div class="columns is-mobile">

		<div class="column fill-vertically">
			<div class="panel full-height is-primary">
				<p class="panel-heading">
					Input
                    <button id="compile-button" class="button is-outlined is-small float-right">
					  <span>▶️ Compile</span>
					</button>
				</p>
				<textArea id="input" class="textarea is-family-code full-height-without-heading" rows="10">
 rem Hello World

 playfield:
................................
......X.X.XXX.X...X...XXX.......
......X.X.X...X...X...X.X.......
......XXX.XX..X...X...X.X.......
......X.X.X...X...X...X.X.......
......X.X.XXX.XXX.XXX.XXX.......
................................
.....X...X.XXX.XX..X...XX.......
.....X...X.X.X.X.X.X...X.X......
.....X.X.X.X.X.XX..X...X.X......
.....XX.XX.XXX.X.X.XXX.XX.......
end

 COLUPF = 22
 COLUBK = 2

mainloop
 drawscreen
 score = score + 1
 goto mainloop

				</textArea>
			</div>
		</div>

		<div id="output" class="column fill-vertically">
		
			<div class="panel is-warning">
				<p class="panel-heading">Loading</p>
				<textArea id="preprocess" class="textarea is-family-code">Please wait...</textArea>
			</div>
			
		</div>
		
		<div class="column fill-vertically is-success">
			<div class="panel is-success">
				<p class="panel-heading">Results</p>
				<div class="block"></div>
				<div class="block">
					<button id="downloadROM" class="button is-success" disabled>Download ROM</button>
				</div>
				<div id="javatari" class="block">
					<div id="javatari-screen"></div>
				</div>
			</div>
		</div>
	</div>
	
	<footer class="footer">
		<div class="panel is-danger">
			<p class="panel-heading">Errors</p>
			<textArea id="error" class="textarea is-family-code has-text-danger" style="color: red"></textArea>
		</div>
	</footer>
  
    <script type="text/javascript" src="third-party/bb2600basic.js"></script>
    <script type="text/javascript" src="third-party/bbpreprocess.js"></script>
    <script type="text/javascript" src="third-party/dasm.js"></script>
    <script type="text/javascript" src="third-party/FileSaver.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/underscore@1.12.0/underscore-min.js"></script>
	
    <script type="text/javascript" src="fsContents.js"></script>
    <script type="text/javascript" src="compiler.js"></script>
	
	<script type="text/javascript">
		Module = { 
			  preRun: function() {
				var position = 0;
				var source = document.getElementById('input').value;
				var out = document.getElementById('output');
				var err = document.getElementById('error');
				
				out.value = '';
				err.value = '';
			  
				function stdin() {
					var ch = position >= source.length ? null : source.charCodeAt(position);
					console.log('stdin', ch);
					position++;
					return ch;
				}

				function stdout(asciiCode) {
					window.blah += String.fromCharCode(asciiCode);
					out.value = out.value + String.fromCharCode(asciiCode);
				}

				function stderr(asciiCode) {
					err.value = err.value + String.fromCharCode(asciiCode);
				}

				FS.init(stdin, stdout, stderr);
				
				FS.writeFile("default.inc", "\nbB.asm\n");
			  },
			  
			  noInitialRun: true
		};
		
		var OUTPUT_TEMPLATE = Handlebars.compile(
					'{{#each contents}}' +
					'	<div class="panel is-{{type}}"><p class="panel-heading">{{name}}</p>' +
					'		<textArea class="textarea is-family-code" readonly>{{content}}</textArea>' +
					'	</div>' +
					'{{/each}}');
		function updateOutput(contents, type) {
			document.getElementById('output').innerHTML = OUTPUT_TEMPLATE({
				contents: Object.entries(contents).map(([name, content]) => ({name, content, type})), 		
			});
		}
		
		function clearOutput() {
			updateOutput({'Compiling': 'Please wait...'}, 'warning');
			document.getElementById('downloadROM').disabled = true;
			document.getElementById('error').value = '';
		}
		
		function setupStdin(fs, code) {
			var i = 0;
			fs.init(function () { return i < code.length ? code.charCodeAt(i++) : null; });
		}
		
		function stderr(asciiCode) {
			var err = document.getElementById('error');
			err.value = err.value + String.fromCharCode(asciiCode);
		}
				
		function executeApplication() {
		
			var remainingTries = 3;
			function tryRunning() {
				try {
					clearOutput();
				
					var source = document.getElementById('input').value;
									
					var preprocessed = preprocessBatariBasic(source);				
					console.info('Preprocessing results', preprocessed);
					var preprocessedResults = {'Preprocessed': preprocessed};
					updateOutput(preprocessedResults, 'info');
					
					var assemblyFiles = compileBatariBasic(preprocessed);				
					console.info('Assembly files generated from BASIC source', assemblyFiles);
					updateOutput(Object.assign({}, preprocessedResults, assemblyFiles), 'info');
					
					var assemblyOutputs = assembleDASM(assemblyFiles);
					console.info('Output files generated from assemblies', assemblyOutputs);
					
					var downloadButton = document.getElementById('downloadROM');
					downloadButton.onclick = () => saveAs(new Blob([assemblyOutputs.output]), 'generated-rom.bin');
					downloadButton.disabled = false;
					
					Javatari.fileLoader.loadFromContent('main.bin', assemblyOutputs.output);
				} catch (e) {
					console.error('Error while compiling', e);
					document.getElementById('error').value = e;
				}
			}
			
			var inputArea = document.getElementById('input');
			var inputEvent = _.debounce(tryRunning, 300);
			inputArea.onchange = inputEvent;
			inputArea.onkeyup = inputEvent;
			document.getElementById('compile-button').onclick = inputEvent;
			
			console.log('First try...');
			tryRunning();
			
		}
	</script>
	<script>
		setTimeout(executeApplication, 1000);
	</script>
	<script src="third-party/javatari.js"></script>
  </body>
</html>
