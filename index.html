<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  </head>
  <body>
  
	<style>
		fieldset {
			display: inline-block;
		}
	</style>
  
	<fieldset>
		<legend>Input</legend>
		<textArea id="input" rows="20" cols="40">
 rem Hello World

 playfield:
................................
......X.X.XXX.X...X...XXX.......
......X.X.X...X...X...X.X.......
......XXX.XX..X...X...X.X.......
......X.X.X...X...X...X.X.......
......X.X.XXX.XXX.XXX.XXX.......
................................
.....X...X.XXX.XX..X...XX.......
.....X...X.X.X.X.X.X...X.X......
.....X.X.X.X.X.XX..X...X.X......
.....XX.XX.XXX.X.X.XXX.XX.......
end

 COLUPF = 22
 COLUBK = 2

mainloop
 drawscreen
 score = score + 1
 goto mainloop

		</textArea>
	</fieldset>

	<fieldset>
		<legend>Preprocess</legend>
		<textArea id="preprocess" rows="20" cols="40"></textArea>
	</fieldset>
	
	<fieldset>
		<legend>Output</legend>
		<textArea id="output" rows="20" cols="40"></textArea>
	</fieldset>
	
	<textArea id="error" rows="20" cols="40" style="color: red"></textArea>
  
	<script type="text/javascript">
		Module = { 
			  preRun: function() {
				var position = 0;
				var source = document.getElementById('input').value;
				var out = document.getElementById('output');
				var err = document.getElementById('error');
				
				out.value = '';
				err.value = '';
			  
				function stdin() {
					var ch = position >= source.length ? null : source.charCodeAt(position);
					console.log('stdin', ch);
					position++;
					return ch;
				}

				function stdout(asciiCode) {
					window.blah += String.fromCharCode(asciiCode);
					out.value = out.value + String.fromCharCode(asciiCode);
				}

				function stderr(asciiCode) {
					err.value = err.value + String.fromCharCode(asciiCode);
				}

				FS.init(stdin, stdout, stderr);
				
				FS.writeFile("default.inc", "\nbB.asm\n");
			  },
			  
			  noInitialRun: true
		};
		
		function clearOutput() {
			document.getElementById('preprocess').value = '';
			document.getElementById('output').value = '';
		}
		
		function setupStdin(fs, code) {
			var i = 0;
			fs.init(function () { return i < code.length ? code.charCodeAt(i++) : null; });
		}
		
		function stderr(asciiCode) {
			var err = document.getElementById('error');
			err.value = err.value + String.fromCharCode(asciiCode);
		}

		function preprocessBatariBasic(code) {
			var bbout = "";
			function addbbout_fn(s) {
				bbout += s;
				bbout += "\n";
			}
			var BBPRE = preprocess({
				noInitialRun: true,
				//logReadFiles:true,
				print: addbbout_fn,
				printErr: stderr,
				noFSInit: true,
			});
			var FS = BBPRE['FS'];
			setupStdin(FS, code);
			BBPRE.callMain([]);
			console.log("preprocess " + code.length + " -> " + bbout.length + " bytes");
			return bbout;
		}
	
		function executeApplication() {
		
			var remainingTries = 3;
			function tryRunning() {
				clearOutput();
				/*
				preRun();
				Module.callMain();
				*/
				
				var source = document.getElementById('input').value;
				document.getElementById('preprocess').value = preprocessBatariBasic(source);
				
				
				/* Still trying to find out why does the compilation randomly fail so often... 
				 * For now, just for demonstration purposes, there's a retry mechanism.
				 */
				setTimeout(function(){
					var outValue = document.getElementById('output').value.trim();
					if (outValue !== '' && outValue !== 'game') {
						console.info('Compile successful.');
						return;
					}
				
					remainingTries--;
					if (remainingTries <= 0) {
						console.log('Completely failed to compile.');
						return;
					}
				
					console.log('Trying again... ' + remainingTries);
					clearOutput();
					tryRunning();
				}, 500);
			}
			
			console.log('First try...');
			tryRunning();
			
		}
	</script>
    <script type="text/javascript" src="bb2600basic.js"></script>
    <script type="text/javascript" src="bbpreprocess.js"></script>
	<script>
		setTimeout(executeApplication, 1000);
	</script>
  </body>
</html>
